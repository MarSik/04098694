# syntax=docker/dockerfile:1
FROM registry.access.redhat.com/ubi9/ubi:9.5

# Install required packages for building and using XDP programs
RUN dnf install -y \
    clang llvm gcc make \
    iproute iproute-tc iputils ethtool \
    kernel-headers kernel-devel \
    libbpf libbpf-devel \
    bpftool elfutils-libelf-devel libpcap-devel perf \
    glibc-devel glibc-devel.i686 \
    git tcpdump lksctp-tools conntrack xdp-tools libxdp \
    && dnf clean all

# Set metadata
LABEL maintainer="midu@redhat.com"
LABEL description="UBI 9.5 container with XDP-related networking tools"
LABEL version="1.0"

# Set working directory
WORKDIR /xdp

# Copy XDP program and loader script
COPY xdp_redirect.c ./

# Clone kernel headers to get bpf_helpers.h
RUN git clone --depth=1 https://github.com/torvalds/linux.git /kernel-headers

# Compile XDP program
RUN clang -O2 -g -Wall -target bpf -I/kernel-headers/tools/lib/bpf/ -c /xdp/xdp_redirect.c -o /xdp/xdp_redirect.o

# Set default command
CMD ["/bin/bash"]
